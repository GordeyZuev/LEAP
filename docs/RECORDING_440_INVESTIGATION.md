# Расследование: Запись #440 — "Недостаточно данных"

**Дата инцидента:** 12.02.2026
**Дата расследования:** 14.02.2026
**Recording ID:** 440
**User:** user_000003 (user_id: 01KGSQMKNX50CEFJFJ39ZBVEK8)
**Template ID:** 30

---

## Что произошло

Запись **"Основы программирования на Python – Экономика, Топалова, гр. 1,2"** была автоматически обработана и загружена на VK с заголовком:

> **Основы программирования на Python – Экономика, Топалова, гр. 1,2 | Недостаточно данных (12.02.26)**

Вместо нормальных тем в `{themes}` оказалось "Недостаточно данных" — это то, что DeepSeek вернул как `main_topic`, потому что транскрипция оказалась полностью галлюцинированной.

---

## Параметры записи

| Параметр | Значение |
|----------|---------|
| **Recording ID** | **440** |
| **Папка** | `storage/users/user_000003/recordings/440/` |
| source.mp4 | 89.3 МБ (89,319,730 байт) |
| video.mp4 (trimmed) | 64.8 МБ (64,796,070 байт) |
| audio.mp3 (trimmed) | 12.9 МБ (12,892,745 байт) |
| Audio boundaries | 59.6s — 1661.1s (после padding: 54.6s — 1666.1s) |
| Длительность после обрезки | ~26.8 мин |
| Сегментов транскрипции | 54 |
| Слов транскрипции | 107 |
| Результат topics | `main_topics: ["Недостаточно данных"]`, `topic_timestamps: []` |

### Для сравнения — нормальная запись #456 (та же преподавательница)

| Параметр | Значение |
|----------|---------|
| source.mp4 | 253 МБ |
| video.mp4 (trimmed) | 247 МБ |
| audio.mp3 | 41.7 МБ |
| Длительность | ~86.8 мин |
| Сегментов | 140 |
| Заголовок | "Множества и словари (12.02.26)" — нормально |

---

## Корневая причина: галлюцинация Whisper на тихом аудио

Транскрипция записи 440 (`segments.txt`) полностью состоит из галлюцинаций:

```
[00:00:05.735 - 00:00:05.756] Тихо.
[00:00:59.979 - 00:01:00.000] Продолжение следует...
[00:01:29.980 - 00:01:30.000] Продолжение следует...
[00:01:59.980 - 00:02:00.000] Продолжение следует...
...
(54 сегмента, ВСЕ — "Продолжение следует..." или "Тихо.")
```

**Ни одного слова реальной речи.** Whisper при работе с тихим/пустым аудио генерирует характерные галлюцинации:
- "Продолжение следует..."
- "Тихо."
- Равномерные интервалы ровно по 30 секунд

### Цепочка отказа

1. **Zoom-запись очень тихая** — вероятно, микрофон был отключен или записан с минимальной громкостью
2. **blank_record проверка прошла** — файл 89 МБ > 25 МБ, длительность > 20 мин
3. **Silence detection** (порог -30 dB) обнаружил "звук" с 59.6s до 1661.1s — вероятно, это был фоновый шум ниже порога речи, но выше порога тишины
4. **Whisper (Fireworks)** получил 26.8 мин тихого аудио → выдал 107 слов-галлюцинаций (avg word duration 2.7s, max 27s)
5. **DeepSeek** получил бессмысленную транскрипцию → вернул `"Недостаточно данных"` как main_topic
6. **Upload** прошёл без проблем — запись загружена на VK с мусорным заголовком

---

## Отсутствующие валидации (что нужно добавить)

### 1. Post-transcription валидация (КРИТИЧНО)

**Сейчас:** никакой проверки качества транскрипции нет. 107 слов из "Продолжение следует..." проходят как валидная транскрипция.

**Нужно проверять:**
- **Hallucination detection** — если >50% сегментов содержат одинаковый текст ("Продолжение следует...", "Тихо.", "Субтитры...", etc.) — это галлюцинация
- **Минимальное количество уникальных слов** — если уникальных слов < 50, транскрипция подозрительная
- **Покрытие** — если средняя длительность слова > 5 секунд, это ненормально (у записи 440: avg=2.7s, но max=27s при 107 словах на 27 мин)
- **Плотность слов** — менее 4 слов/минуту = подозрительно (запись 440: 107 слов / 27 мин ≈ 4 слова/мин). Нормальная речь — 100-150 слов/мин

### 2. Post-trim валидация громкости

**Сейчас:** после обрезки не проверяется громкость оставшегося аудио.

**Можно добавить:**
```bash
ffmpeg -i audio.mp3 -af loudnorm=print_format=json -f null -
```
Это даёт `input_i` (integrated LUFS). Если < -35 LUFS — аудио аномально тихое.

### 3. Валидация перед загрузкой

**Сейчас:** если `main_topics` пуст или содержит мусор — запись всё равно загружается с `{themes}` = мусор.

**Нужно:**
- Фильтровать известные паттерны ("Недостаточно данных", "Не удалось", etc.)
- Не загружать с пустыми/мусорными темами или использовать fallback

---

## Известные паттерны галлюцинаций Whisper

При тихом/пустом аудио Whisper (особенно whisper-v3-turbo) генерирует:

| Паттерн | Описание |
|---------|----------|
| `Продолжение следует...` | Самый частый, ровные интервалы по 30с |
| `Тихо.` | Одно слово |
| `Субтитры сделал DimaTorzworking` | Копирование "водяных знаков" |
| `Редактор субтитров` | Из обучающих данных |
| `Корректор` | Из обучающих данных |
| Пустые сегменты | Нулевая длительность |

### Паттерн: равномерные 30-секундные интервалы

Whisper обрабатывает аудио чанками по 30 секунд. При тихом аудио он выдаёт ровно один "сегмент" на чанк, с таймкодами кратными 30с:

```
00:00:59.979 → 00:01:00.000
00:01:29.980 → 00:01:30.000
00:01:59.980 → 00:02:00.000
```

Это яркий индикатор галлюцинации.

---

## Предлагаемые решения

### Вариант A: Hallucination Detector (рекомендуется)

Добавить проверку после транскрипции:

```python
HALLUCINATION_PATTERNS = [
    "продолжение следует",
    "тихо",
    "субтитры",
    "редактор субтитров",
    "корректор",
]

def detect_hallucination(segments: list[dict]) -> bool:
    """Detect Whisper hallucination in transcription."""
    if not segments:
        return True

    texts = [s.get("text", "").strip().lower().rstrip(".!?…") for s in segments]
    unique_texts = set(texts)

    # Слишком мало уникальных текстов
    if len(unique_texts) <= 3 and len(segments) > 10:
        return True

    # Известные паттерны галлюцинаций
    hallucination_count = sum(
        1 for t in texts
        if any(p in t for p in HALLUCINATION_PATTERNS)
    )
    if hallucination_count / len(segments) > 0.5:
        return True

    # Плотность слов слишком низкая
    total_words = sum(len(s.get("text", "").split()) for s in segments)
    total_duration = segments[-1].get("end", 0) - segments[0].get("start", 0)
    if total_duration > 300 and total_words / (total_duration / 60) < 10:
        return True  # менее 10 слов в минуту

    return False
```

### Вариант B: Остановка пайплайна

Если галлюцинация обнаружена:
- Пометить запись как `FAILED` с `failed_reason = "Hallucinated transcription (audio too quiet)"`
- Не запускать topic extraction и upload
- Уведомить пользователя

### Вариант C: Audio loudness pre-check

Перед транскрипцией проверить LUFS:
```bash
ffmpeg -i audio.mp3 -af loudnorm=print_format=json -f null - 2>&1
```
Если `input_i` < -35 LUFS → пометить как проблемную.

---

## Хронология из логов (app.log)

```
15:07:12 | Recording 440 source processing completed: PENDING_SOURCE → INITIALIZED
15:08:42 | Smart run: starting full pipeline for recording 440 (status=INITIALIZED)
15:08:42 | Downloading recording 440: Экономика_Основы программирования на Python_группа 1,2_Топалова Я.Р.
15:09:29 | Recording 440 downloaded successfully
15:09:29 | Trimming video 440
15:09:29 | Extracting full audio: id=440
15:09:32 | Audio boundaries: 59.6s - 1661.1s
15:09:32 | Audio boundaries detected: 54.6s - 1666.1s (с padding)
15:09:32 | Trimming complete: id=440
15:09:32 | Transcribing recording 440
15:09:32 | Fireworks | Attempt 1/3 | model=whisper-v3-turbo
15:09:48 | Fireworks | Success: elapsed=15.7s
15:09:48 | Words: total=107 | avg=2.697s | max=27.082s | long=18
15:09:48 | Transcription completed: words=107, segments=54
15:09:48 | Extracting topics for recording 440
15:09:55 | Successfully extracted with deepseek for recording 440
15:09:55 | Added topics version v1: topics=0, model=deepseek  ← 0 topics!
15:09:55 | Launching uploads: platforms=['vk']
15:09:55 | Uploading video to VK: ...| Недостаточно данных (12.02.26)
15:10:01 | Updated recording 440 aggregate status to READY
```

**Ключевые красные флаги, которые были проигнорированы:**
- `words=107` на 27 мин → ~4 слова/мин (норма 100-150)
- `avg=2.697s` на слово (норма ~0.3-0.5s)
- `max=27.082s` — одно "слово" длилось 27 секунд
- `long=18` — 18 из 107 слов "длинные"
- `topics=0` — 0 детализированных тем (но upload всё равно пошёл!)

---

## Выводы и приоритеты

1. **[P0] Hallucination detector** — добавить проверку после транскрипции, остановить пайплайн если обнаружена галлюцинация
2. **[P1] Post-topics gate** — не загружать если `main_topics` пуст или `topic_timestamps` пуст (0 тем — явная проблема)
3. **[P2] Word density check** — если < 10 слов/мин, помечать как подозрительную
4. **[P3] Audio loudness check** — опциональная проверка LUFS перед транскрипцией
