# Batch Testing Report: 24 записи (12.02.2026)

## 1. Общая сводка

| Метрика | Значение |
|---|---|
| Записей запущено | 24 |
| Успешно обработано | **24 (100%)** |
| Ошибок (failed) | 0 |
| Retry (upload) | 1 (rec 398, VK "Unknown error", retry успешен) |
| Контента суммарно | **42.4 часа** (2 542 мин) |
| Скачано данных | **7.2 ГБ** |
| Wall-clock (от первого start до последнего complete) | **25 мин 49 сек** |
| Throughput батча | **42.4 часа контента за 25.8 мин = 98.5x realtime** |

## 2. Характеристики записей

| Метрика | Значение |
|---|---|
| Средняя длительность | 105.9 мин |
| Диапазон длительности | 23 – 298 мин |
| Средний размер файла | 300.1 МБ |
| Диапазон размеров | 48 МБ – 1 309 МБ |
| Источник | Zoom (все 24) |
| Язык | RU (все 24) |
| Выход | VK Video (все 24) |

## 3. Распределение времени по этапам

| Этап | Суммарно | % пайплайна | Avg | Median | Min | Max |
|---|---|---|---|---|---|---|
| **DOWNLOAD** | 10 604 сек | **66.5%** | 441.8 сек | 419.9 сек | 13.8 сек | 1 083.4 сек |
| **UPLOAD:VK** | 3 621 сек | **22.7%** | 144.9 сек | 96.9 сек | 7.6 сек | 413.5 сек |
| **TRANSCRIBE** | 974 сек | **6.1%** | 40.6 сек | 30.3 сек | 10.4 сек | 150.6 сек |
| **EXTRACT_TOPICS** | 496 сек | **3.1%** | 20.7 сек | 17.1 сек | 13.8 сек | 44.0 сек |
| **TRIM** | 251 сек | **1.6%** | 10.4 сек | 9.0 сек | 2.2 сек | 27.8 сек |
| **GENERATE_SUBTITLES** | 0.3 сек | **~0%** | 0.01 сек | 0.01 сек | 0.01 сек | 0.02 сек |

## 4. Скорость скачивания из Zoom

24 параллельных загрузки конкурировали за полосу пропускания.

| Группа | Записей | Скорость | Комментарий |
|---|---|---|---|
| Быстрые | 2 (433, 454) | 3.5 – 5.1 МБ/с | Маленькие файлы, скачались до насыщения канала |
| Средние | 3 (427, 385, 276) | 0.95 – 1.9 МБ/с | — |
| Медленные | 19 | 0.39 – 0.88 МБ/с | Канал насыщен параллельными загрузками |
| **Среднее по батчу** | — | **~0.7 МБ/с** | — |

## 5. Скорость загрузки в VK

| Метрика | Значение |
|---|---|
| Пиковая | 5.42 МБ/с (rec 385, 1.3 ГБ) |
| Верхний квартиль | 2.9 – 5.3 МБ/с |
| Медиана | ~2.1 МБ/с |
| Нижний квартиль | 1.1 – 1.5 МБ/с |
| Ошибки | 1/25 (4%), retry успешен |

## 6. Транскрипция (Fireworks API)

| Метрика | Значение |
|---|---|
| Всего распознано | ~181 000 слов |
| Средняя скорость | 230 слов/сек |
| Realtime factor (медиана) | ~170x |
| Лучший RT factor | 304x (rec 276, 68 мин за 13 сек) |
| Худший RT factor | 108x (rec 427, 85 мин за 47 сек) |

## 7. Извлечение тем (DeepSeek)

| Метрика | Значение |
|---|---|
| Среднее время | 20.7 сек |
| Медиана | 17.1 сек |
| Макс. | 44.0 сек (rec 385, 298 мин, 23K слов) |
| Гранулярность | `long` (все 24) |

## 8. Тримминг (FFmpeg)

| Подэтап | Avg | Min | Max |
|---|---|---|---|
| extract_audio | 6.3 сек | 1.3 сек | 18.3 сек |
| analyze_silence | 1.6 сек | 0.4 сек | 3.8 сек |
| trim_video | 0.8 сек | 0.3 сек | 1.5 сек |
| trim_audio | 0.3 сек | 0.1 сек | 0.5 сек |

`extract_audio` — 60% времени тримминга, линейно зависит от длины видео.

## 9. Эффективность пайплайна

| Метрика | Значение |
|---|---|
| Pipeline time / Content time (avg) | 12.7% |
| Лучший случай | 6.6% |
| Худший случай | 31.5% (rec 398, retry upload) |

## 10. Топ-5 самых долгих пайплайнов

| ID | Название | Длит. | Размер | Пайплайн |
|---|---|---|---|---|
| 385 | История\_Программирование на Python\_группа 1 | 298 мин | 1.3 ГБ | **25.8 мин** |
| 198 | Дизайн СПБ\_Анализ данных\_группа 5,6 | 205 мин | 764 МБ | **24.3 мин** |
| 398 | AI и no-code для менеджмента | 77 мин | 285 МБ | **24.2 мин** (retry) |
| 329 | Python для анализа данных\_группа 3,4 | 163 мин | 563 МБ | **23.6 мин** |
| 447 | ИИ для бизнеса: автоматизация | 237 мин | 402 МБ | **19.7 мин** |

## 11. Топ-5 самых быстрых пайплайнов

| ID | Название | Длит. | Размер | Пайплайн |
|---|---|---|---|---|
| 426 | ФИКЛ\_Программирование\_группа 1 | 31 мин | 77 МБ | **4.6 мин** |
| 454 | Цифровой юрист\_Анализ данных | 23 мин | 48 МБ | **5.2 мин** |
| 283 | Цифровой юрист\_Анализ данных | 79 мин | 98 МБ | **5.2 мин** |
| 433 | ФИКЛ\_Программирование\_группа 1 | 74 мин | 93 МБ | **5.8 мин** |
| 287 | Право\_Анализ данных в Python | 83 мин | 144 МБ | **6.4 мин** |

---

## 12. Выявленные проблемы

### 12.1 Bottleneck: все I/O-задачи в одной очереди

**Конфигурация на момент теста:**

| Воркер | Пул | Concurrency | Очередь |
|---|---|---|---|
| celery-async | threads | 20 | `async_operations` (download + transcribe + topics + subtitles + upload + orchestration) |
| celery-cpu | prefork | 3 | `processing_cpu` (trim) |
| celery-maintenance | prefork | 1 | `maintenance` |

Все I/O-задачи конкурировали за 20 потоков в одной очереди. На пике (14:18–14:19) нагрузка достигала **37 задач** при лимите 20:

```
Время  | DL  | TRIM | TXN | TPC | UPL | ВСЕГО | Лимит async
-------|-----|------|-----|-----|-----|-------|------------
14:15  | 20  |   0  |  0  |  0  |  0  |  20   |  20  ← загружен
14:18  | 23  |   7  |  3  |  0  |  0  |  33   |  20  ← ПЕРЕГРУЗКА
14:19  | 17  |   2  |  7  |  6  |  0  |  37   |  20  ← ПЕРЕГРУЗКА x1.85
14:21  | 15  |   3  |  3  |  2  |  7  |  31   |  20  ← ПЕРЕГРУЗКА
14:27  |  7  |   4  |  5  |  5  |  3  |  28   |  20  ← ПЕРЕГРУЗКА
```

### 12.2 Простои между этапами (задачи ждали свободный thread)

| Переход | Avg ожидание | Max ожидание | Суммарно потеряно |
|---|---|---|---|
| TRIM → TRANSCRIBE | 7.1 сек | **51.1 сек** | 170 сек |
| TRANSCRIBE → EXTRACT_TOPICS | 13.8 сек | **29.0 сек** | 165 сек |
| EXTRACT_TOPICS → UPLOAD:VK | 52.5 сек | **611 сек** | 630 сек |
| DOWNLOAD → TRIM | 0.3 сек | 4.3 сек | 6 сек ✓ |

Записи с маленькими файлами страдали больше всего — они быстро скачивались, но потом ждали thread для транскрипции:

| ID | Простой | Pipeline | % простоя |
|---|---|---|---|
| 398 | 616 сек | 1454 сек | **42.4%** |
| 426 | 104 сек | 278 сек | **37.6%** |
| 433 | 72 сек | 349 сек | **20.7%** |
| 276 | 89 сек | 439 сек | **20.4%** |

### 12.3 Баг: maintenance-очередь

Maintenance-задачи роутились в `async_operations`, а воркер `celery-maintenance` слушал пустую очередь `maintenance`.

---

## 13. Применённые исправления

### 13.1 Разделение на 5 очередей

**`api/celery_app.py`** — task routing:

| Очередь | Задачи | Обоснование |
|---|---|---|
| `downloads` | `download_recording` | Изоляция долгих сетевых загрузок |
| `uploads` | `upload.*` | Изоляция от processing |
| `async_operations` | `transcribe`, `extract_topics`, `generate_subtitles`, `run_recording`, `launch_uploads`, `template.*`, `sync.*`, `automation.*` | Быстрые I/O-задачи |
| `processing_cpu` | `trim_video` | CPU-bound (FFmpeg) |
| `maintenance` | `maintenance.*` | Периодические задачи (исправлен баг) |

### 13.2 Увеличение concurrency

**`Makefile`** — параметры воркеров:

| Воркер | Было | Стало |
|---|---|---|
| celery-downloads | — | threads, **12** (новый) |
| celery-uploads | — | threads, **15** (новый) |
| celery-async | threads, 20 | threads, **25** |
| celery-cpu | prefork, 3 | prefork, **4** |
| celery-maintenance | prefork, 1 | prefork, 1 |
| **Итого слотов** | **24** | **57** |

### 13.3 Ожидаемый эффект

| Метрика | До | После (ожидание) |
|---|---|---|
| Простой TRIM → TXN (avg) | 7.1 сек | < 1 сек |
| Простой TRIM → TXN (max) | 51 сек | < 3 сек |
| Записи с > 15% idle | 8 из 24 | 0 |
| Скорость download (avg) | ~0.7 МБ/с | ~1.0–1.5 МБ/с (меньше конкуренция: 12 vs 20) |

---

## 14. Рекомендации на будущее

1. **Приоритеты задач** — Redis broker уже поддерживает `priority_steps` 0–9. Можно давать более высокий приоритет transcribe/topics vs download для ускорения обработки готовых файлов.
2. **Адаптивный download concurrency** — при батчах > 20 записей ограничивать параллельные загрузки до 8–10 для лучшей скорости на поток.
3. **Мониторинг** — добавить Flower dashboard или Prometheus-метрики для отслеживания queue depth и worker utilization в реальном времени.
4. **Повторный бенчмарк** — провести аналогичный тест после применения изменений и сравнить метрики.
