# Batch Testing Report: 24 записи (12.02.2026)

## 1. Общая сводка

| Метрика | Значение |
|---|---|
| Записей запущено | 24 |
| Успешно обработано | **24 (100%)** |
| Ошибок (failed) | 0 |
| Retry (upload) | 1 (rec 398, VK "Unknown error", retry успешен) |
| Контента суммарно | **42.4 часа** (2 542 мин) |
| Скачано данных | **7.2 ГБ** |
| Wall-clock (от первого start до последнего complete) | **25 мин 49 сек** |
| Throughput батча | **42.4 часа контента за 25.8 мин = 98.5x realtime** |

## 2. Характеристики записей

| Метрика | Значение |
|---|---|
| Средняя длительность | 105.9 мин |
| Диапазон длительности | 23 – 298 мин |
| Средний размер файла | 300.1 МБ |
| Диапазон размеров | 48 МБ – 1 309 МБ |
| Источник | Zoom (все 24) |
| Язык | RU (все 24) |
| Выход | VK Video (все 24) |

## 3. Распределение времени по этапам

| Этап | Суммарно | % пайплайна | Avg | Median | Min | Max |
|---|---|---|---|---|---|---|
| **DOWNLOAD** | 10 604 сек | **66.5%** | 441.8 сек | 419.9 сек | 13.8 сек | 1 083.4 сек |
| **UPLOAD:VK** | 3 621 сек | **22.7%** | 144.9 сек | 96.9 сек | 7.6 сек | 413.5 сек |
| **TRANSCRIBE** | 974 сек | **6.1%** | 40.6 сек | 30.3 сек | 10.4 сек | 150.6 сек |
| **EXTRACT_TOPICS** | 496 сек | **3.1%** | 20.7 сек | 17.1 сек | 13.8 сек | 44.0 сек |
| **TRIM** | 251 сек | **1.6%** | 10.4 сек | 9.0 сек | 2.2 сек | 27.8 сек |
| **GENERATE_SUBTITLES** | 0.3 сек | **~0%** | 0.01 сек | 0.01 сек | 0.01 сек | 0.02 сек |

## 4. Скорость скачивания из Zoom

24 параллельных загрузки конкурировали за полосу пропускания.

| Группа | Записей | Скорость | Комментарий |
|---|---|---|---|
| Быстрые | 2 (433, 454) | 3.5 – 5.1 МБ/с | Маленькие файлы, скачались до насыщения канала |
| Средние | 3 (427, 385, 276) | 0.95 – 1.9 МБ/с | — |
| Медленные | 19 | 0.39 – 0.88 МБ/с | Канал насыщен параллельными загрузками |
| **Среднее по батчу** | — | **~0.7 МБ/с** | — |

## 5. Скорость загрузки в VK

| Метрика | Значение |
|---|---|
| Пиковая | 5.42 МБ/с (rec 385, 1.3 ГБ) |
| Верхний квартиль | 2.9 – 5.3 МБ/с |
| Медиана | ~2.1 МБ/с |
| Нижний квартиль | 1.1 – 1.5 МБ/с |
| Ошибки | 1/25 (4%), retry успешен |

## 6. Транскрипция (Fireworks API)

| Метрика | Значение |
|---|---|
| Всего распознано | ~181 000 слов |
| Средняя скорость | 230 слов/сек |
| Realtime factor (медиана) | ~170x |
| Лучший RT factor | 304x (rec 276, 68 мин за 13 сек) |
| Худший RT factor | 108x (rec 427, 85 мин за 47 сек) |

## 7. Извлечение тем (DeepSeek)

| Метрика | Значение |
|---|---|
| Среднее время | 20.7 сек |
| Медиана | 17.1 сек |
| Макс. | 44.0 сек (rec 385, 298 мин, 23K слов) |
| Гранулярность | `long` (все 24) |

## 8. Тримминг (FFmpeg)

| Подэтап | Avg | Min | Max |
|---|---|---|---|
| extract_audio | 6.3 сек | 1.3 сек | 18.3 сек |
| analyze_silence | 1.6 сек | 0.4 сек | 3.8 сек |
| trim_video | 0.8 сек | 0.3 сек | 1.5 сек |
| trim_audio | 0.3 сек | 0.1 сек | 0.5 сек |

`extract_audio` — 60% времени тримминга, линейно зависит от длины видео.

## 9. Эффективность пайплайна

| Метрика | Значение |
|---|---|
| Pipeline time / Content time (avg) | 12.7% |
| Лучший случай | 6.6% |
| Худший случай | 31.5% (rec 398, retry upload) |

## 10. Топ-5 самых долгих пайплайнов

| ID | Название | Длит. | Размер | Пайплайн |
|---|---|---|---|---|
| 385 | История\_Программирование на Python\_группа 1 | 298 мин | 1.3 ГБ | **25.8 мин** |
| 198 | Дизайн СПБ\_Анализ данных\_группа 5,6 | 205 мин | 764 МБ | **24.3 мин** |
| 398 | AI и no-code для менеджмента | 77 мин | 285 МБ | **24.2 мин** (retry) |
| 329 | Python для анализа данных\_группа 3,4 | 163 мин | 563 МБ | **23.6 мин** |
| 447 | ИИ для бизнеса: автоматизация | 237 мин | 402 МБ | **19.7 мин** |

## 11. Топ-5 самых быстрых пайплайнов

| ID | Название | Длит. | Размер | Пайплайн |
|---|---|---|---|---|
| 426 | ФИКЛ\_Программирование\_группа 1 | 31 мин | 77 МБ | **4.6 мин** |
| 454 | Цифровой юрист\_Анализ данных | 23 мин | 48 МБ | **5.2 мин** |
| 283 | Цифровой юрист\_Анализ данных | 79 мин | 98 МБ | **5.2 мин** |
| 433 | ФИКЛ\_Программирование\_группа 1 | 74 мин | 93 МБ | **5.8 мин** |
| 287 | Право\_Анализ данных в Python | 83 мин | 144 МБ | **6.4 мин** |

---

## 12. Выявленные проблемы

### 12.1 Bottleneck: все I/O-задачи в одной очереди

**Конфигурация на момент теста:**

| Воркер | Пул | Concurrency | Очередь |
|---|---|---|---|
| celery-async | threads | 20 | `async_operations` (download + transcribe + topics + subtitles + upload + orchestration) |
| celery-cpu | prefork | 3 | `processing_cpu` (trim) |
| celery-maintenance | prefork | 1 | `maintenance` |

Все I/O-задачи конкурировали за 20 потоков в одной очереди. На пике (14:18–14:19) нагрузка достигала **37 задач** при лимите 20:

```
Время  | DL  | TRIM | TXN | TPC | UPL | ВСЕГО | Лимит async
-------|-----|------|-----|-----|-----|-------|------------
14:15  | 20  |   0  |  0  |  0  |  0  |  20   |  20  ← загружен
14:18  | 23  |   7  |  3  |  0  |  0  |  33   |  20  ← ПЕРЕГРУЗКА
14:19  | 17  |   2  |  7  |  6  |  0  |  37   |  20  ← ПЕРЕГРУЗКА x1.85
14:21  | 15  |   3  |  3  |  2  |  7  |  31   |  20  ← ПЕРЕГРУЗКА
14:27  |  7  |   4  |  5  |  5  |  3  |  28   |  20  ← ПЕРЕГРУЗКА
```

### 12.2 Простои между этапами (задачи ждали свободный thread)

| Переход | Avg ожидание | Max ожидание | Суммарно потеряно |
|---|---|---|---|
| TRIM → TRANSCRIBE | 7.1 сек | **51.1 сек** | 170 сек |
| TRANSCRIBE → EXTRACT_TOPICS | 13.8 сек | **29.0 сек** | 165 сек |
| EXTRACT_TOPICS → UPLOAD:VK | 52.5 сек | **611 сек** | 630 сек |
| DOWNLOAD → TRIM | 0.3 сек | 4.3 сек | 6 сек ✓ |

Записи с маленькими файлами страдали больше всего — они быстро скачивались, но потом ждали thread для транскрипции:

| ID | Простой | Pipeline | % простоя |
|---|---|---|---|
| 398 | 616 сек | 1454 сек | **42.4%** |
| 426 | 104 сек | 278 сек | **37.6%** |
| 433 | 72 сек | 349 сек | **20.7%** |
| 276 | 89 сек | 439 сек | **20.4%** |

### 12.3 Баг: maintenance-очередь

Maintenance-задачи роутились в `async_operations`, а воркер `celery-maintenance` слушал пустую очередь `maintenance`.

---

## 13. Применённые исправления

### 13.1 Разделение на 5 очередей

**`api/celery_app.py`** — task routing:

| Очередь | Задачи | Обоснование |
|---|---|---|
| `downloads` | `download_recording` | Изоляция долгих сетевых загрузок |
| `uploads` | `upload.*` | Изоляция от processing |
| `async_operations` | `transcribe`, `extract_topics`, `generate_subtitles`, `run_recording`, `launch_uploads`, `template.*`, `sync.*`, `automation.*` | Быстрые I/O-задачи |
| `processing_cpu` | `trim_video` | CPU-bound (FFmpeg) |
| `maintenance` | `maintenance.*` | Периодические задачи (исправлен баг) |

### 13.2 Увеличение concurrency

**`Makefile`** — параметры воркеров:

| Воркер | Было | Стало |
|---|---|---|
| celery-downloads | — | threads, **12** (новый) |
| celery-uploads | — | threads, **15** (новый) |
| celery-async | threads, 20 | threads, **25** |
| celery-cpu | prefork, 3 | prefork, **4** |
| celery-maintenance | prefork, 1 | prefork, 1 |
| **Итого слотов** | **24** | **57** |

### 13.3 Ожидаемый эффект

| Метрика | До | После (ожидание) |
|---|---|---|
| Простой TRIM → TXN (avg) | 7.1 сек | < 1 сек |
| Простой TRIM → TXN (max) | 51 сек | < 3 сек |
| Записи с > 15% idle | 8 из 24 | 0 |
| Скорость download (avg) | ~0.7 МБ/с | ~1.0–1.5 МБ/с (меньше конкуренция: 12 vs 20) |

---

## 14. Рекомендации на будущее

1. **Приоритеты задач** — Redis broker уже поддерживает `priority_steps` 0–9. Можно давать более высокий приоритет transcribe/topics vs download для ускорения обработки готовых файлов.
2. **Адаптивный download concurrency** — при батчах > 20 записей ограничивать параллельные загрузки до 8–10 для лучшей скорости на поток.
3. **Мониторинг** — добавить Flower dashboard или Prometheus-метрики для отслеживания queue depth и worker utilization в реальном времени.
4. **Повторный бенчмарк** — провести аналогичный тест после применения изменений и сравнить метрики.

---

# Batch Test #2: 11 записей после изменения воркеров (14.02.2026)

## 15. Общая сводка

| Метрика | Значение |
|---|---|
| Записей запущено | 11 |
| Успешно обработано | **11 (100%)** |
| Ошибок (failed) | 0 |
| Retry | 0 |
| Контента суммарно | **13.4 часа** (806.6 мин) |
| Скачано данных | **2.4 ГБ** |
| Wall-clock (от первого start до последнего complete) | **17 мин 5 сек** |
| Throughput батча | **13.4 часа контента за 17.1 мин = 47x realtime** |

> Параллельно обрабатывалась запись 462 от другого пользователя (YouTube + VK, 92 мин, 144.8 МБ) — завершена за 10 мин 12 сек без влияния на батч.

## 16. Характеристики записей

| Метрика | Значение |
|---|---|
| Средняя длительность | 73.3 мин |
| Диапазон длительности | 51.5 – 103.4 мин |
| Средний размер файла | 225.6 МБ |
| Диапазон размеров | 89.5 МБ – 395.1 МБ |
| Источник | Zoom (все 11) |
| Язык | RU (все 11) |
| Выход | VK Video (все 11) |

## 17. Распределение времени по этапам

| Этап | Суммарно | % пайплайна | Avg | Median | Min | Max |
|---|---|---|---|---|---|---|
| **DOWNLOAD** | 7 506 сек | **88.3%** | 682.4 сек | 704.0 сек | 251.0 сек | 915.0 сек |
| **UPLOAD:VK** | 591 сек | **6.9%** | 53.7 сек | 42.0 сек | 14.0 сек | 96.0 сек |
| **TRANSCRIBE** | 187 сек | **2.2%** | 17.0 сек | 17.2 сек | 10.8 сек | 21.3 сек |
| **EXTRACT_TOPICS** | 132 сек | **1.5%** | 12.0 сек | 11.0 сек | 9.5 сек | 15.0 сек |
| **TRIM** | 90 сек | **1.1%** | 8.2 сек | 8.0 сек | 5.0 сек | 11.0 сек |
| **GENERATE_SUBTITLES** | ~0.8 сек | **~0%** | ~0.07 сек | ~0.07 сек | 0.06 сек | 0.10 сек |

## 18. Ключевой результат: устранение простоев между этапами

**До (Batch #1, 24 записи, одна очередь):**

| Переход | Avg ожидание | Max ожидание |
|---|---|---|
| TRIM → TRANSCRIBE | 7.1 сек | 51.1 сек |
| TRANSCRIBE → EXTRACT_TOPICS | 13.8 сек | 29.0 сек |
| EXTRACT_TOPICS → UPLOAD:VK | 52.5 сек | 611 сек |

**После (Batch #2, 11 записей, 5 очередей):**

| Переход | Avg ожидание | Max ожидание |
|---|---|---|
| TRIM → TRANSCRIBE | **< 1 сек** | **< 1 сек** |
| TRANSCRIBE → EXTRACT_TOPICS | **< 1 сек** | **< 1 сек** |
| EXTRACT_TOPICS → UPLOAD:VK | **< 1 сек** | **~2 сек** |

Записи с > 15% idle: **0 из 11** (было 8 из 24).

Разделение на 5 очередей полностью устранило конкуренцию между этапами — каждая задача немедленно получала thread в своём воркере.

## 19. Сравнение ожидаемого и фактического эффекта

| Метрика | Было (Batch #1) | Ожидание (§13.3) | Факт (Batch #2) | Статус |
|---|---|---|---|---|
| Простой TRIM → TXN (avg) | 7.1 сек | < 1 сек | **< 1 сек** | Выполнено |
| Простой TRIM → TXN (max) | 51 сек | < 3 сек | **< 1 сек** | Превышено |
| Записи с > 15% idle | 8 из 24 | 0 | **0 из 11** | Выполнено |
| Простой Topics → Upload (avg) | 52.5 сек | — | **< 1 сек** | Выполнено |
| Простой Topics → Upload (max) | 611 сек | — | **~2 сек** | Выполнено |

## 20. Транскрипция (Fireworks API)

| Метрика | Значение |
|---|---|
| Всего распознано | ~63 300 слов |
| Средняя скорость | 338 слов/сек |
| Realtime factor (медиана) | ~275x |
| Лучший RT factor | 303x (rec 526, 76 мин за 15.1 сек) |
| Худший RT factor | 200x (rec 545, 53 мин за 15.8 сек) |

## 21. Извлечение тем (DeepSeek)

| Метрика | Значение |
|---|---|
| Среднее время | 12.0 сек |
| Медиана | 11.0 сек |
| Макс. | 15.0 сек (rec 595, 76 мин, 5.9K слов) |
| Гранулярность | `long` (все 11) |

## 22. Загрузка в VK

| Метрика | Значение |
|---|---|
| Пиковая скорость | 7.6 МБ/с (rec 526, 129 МБ) |
| Медиана | ~5.5 МБ/с |
| Нижний квартиль | ~3.3 МБ/с |
| Ошибки | 0/11 (0%) |

## 23. Таймлайн: все 11 записей

| ID | Название | Длит. | Размер | DL | Trim | TXN | Topics | Upload | Пайплайн | READY |
|---|---|---|---|---|---|---|---|---|---|---|
| 589 | Прог. Python – История, Бакшук, гр. 10 | 51.5 мин | 89.5 МБ | 251 сек | 5 сек | 10.8 сек | 10 сек | 14 сек | **4 мин 52 сек** | 16:02:52 |
| 526 | Анализ данных – Востоковед., Хорин, гр. 3 | 76.3 мин | 128.6 МБ | 462 сек | 7 сек | 15.1 сек | 9.5 сек | 17 сек | **8 мин 32 сек** | 16:06:32 |
| 545 | Анализ данных – Право, Касьяненко, гр. 5,6 | 52.7 мин | 127.5 МБ | 540 сек | 7 сек | 15.8 сек | 11 сек | 38 сек | **10 мин 13 сек** | 16:08:13 |
| 546 | Анализ данных – Право, Касьяненко, гр. 5,6 | 61.9 мин | 126.2 МБ | 537 сек | 8 сек | 17.2 сек | 13 сек | 42 сек | **10 мин 17 сек** | 16:08:17 |
| 596 | Прог. Python – История, Бакшук, гр. 11 | 72.7 мин | 159.9 МБ | 633 сек | 7 сек | 19.1 сек | 11 сек | 29 сек | **11 мин 41 сек** | 16:09:41 |
| 527 | Анализ данных – Востоковед., Хорин, гр. 3 | 83.6 мин | 197.4 МБ | 704 сек | 8 сек | 18.1 сек | 14 сек | 32 сек | **12 мин 57 сек** | 16:10:57 |
| 481 | Прог. Python – Экономика, Топалова, гр. 1,2 | 85.2 мин | 279.3 МБ | 851 сек | 11 сек | 18.6 сек | 14 сек | 71 сек | **16 мин 8 сек** | 16:14:08 |
| 591 | Прог. Python – История, Галушко, гр. 1 | 66.8 мин | 330.3 МБ | 858 сек | 8 сек | 16.4 сек | 10 сек | 96 сек | **16 мин 29 сек** | 16:14:29 |
| 595 | Прог. Python – История, Галушко, гр. 1 | 76.1 мин | 314.5 МБ | 874 сек | 9 сек | 15.2 сек | 15 сек | 96 сек | **16 мин 51 сек** | 16:14:51 |
| 519 | Прог. Python – Матфак, Кубаева, гр. 1 | 103.4 мин | 333.7 МБ | 881 сек | 11 сек | 21.3 сек | 11 сек | 89 сек | **16 мин 53 сек** | 16:14:53 |
| 586 | Прог. Python – История, Галушко, гр. 1 | 76.4 мин | 395.1 МБ | 915 сек | 9 сек | 19.6 сек | 13 сек | 67 сек | **17 мин 5 сек** | 16:15:05 |

## 24. Конфигурация воркеров на момент теста

| Воркер | Пул | Concurrency | Очередь |
|---|---|---|---|
| celery-downloads | threads | 12 | `downloads` |
| celery-uploads | threads | 15 | `uploads` |
| celery-async | threads | 25 | `async_operations` (transcribe, topics, subtitles, orchestration) |
| celery-cpu | prefork | 4 | `processing_cpu` (trim) |
| celery-maintenance | prefork | 1 | `maintenance` |
| **Итого слотов** | | **57** | |

## 25. Замечания

1. **Download bottleneck ещё более выражен** — 88.3% времени пайплайна (было 66.5%). Это ожидаемо: после устранения простоев между этапами, download стал единственным узким местом.
2. **Upload стал быстрее** — avg 53.7 сек vs 144.9 сек в Batch #1. Отдельная очередь `uploads` с 15 threads исключила конкуренцию с download/transcribe.
3. **Отсутствие thumbnails** — для 4 записей (545, 546, 526, 589) thumbnails `andan_start.png` и `prog_start.png` не найдены. Видео загружены без обложек.
4. **AsyncClient `Event loop is closed`** — неблокирующий warning в celery-async при закрытии httpx клиента DeepSeek. Не влияет на результат, но стоит исправить.
5. **Запись 462** — обрабатывалась параллельно от другого пользователя (YouTube + VK, retry download из-за expired token). Успешно завершена за 10 мин 12 сек, что подтверждает изоляцию между пользователями.

---

# 26. Выводы: сравнение двух батчей

## 26.1 Условия тестов различались

Тесты проводились в **разных сетевых условиях**, что критически важно для интерпретации.

### Измерение пропускной способности сети по фактическим загрузкам

**Скачивание из Zoom (download):**

| Параметр | Batch #1 (12.02) | Batch #2 (14.02) | Разница |
|---|---|---|---|
| Всего скачано | 7.2 ГБ | 2.4 ГБ | — |
| Период скачивания | ~18 мин (14:15–14:33) | ~15 мин (15:58–16:13) | — |
| **Агрегатный throughput** | **6.6 МБ/с (~53 Mbps)** | **2.7 МБ/с (~22 Mbps)** | **2.4x медленнее** |
| Скорость на файл (avg) | ~0.28 МБ/с | ~0.25 МБ/с | ~одинаково |
| Параллельных загрузок | 24 | 11 | — |

> Агрегатная полоса Batch #2 была в 2.4 раза уже. При этом скорость **на один файл** была сопоставимой (~0.25–0.28 МБ/с), т.к. каждый файл получал пропорциональную долю канала.

**Загрузка в VK (upload):**

| Параметр | Batch #1 (12.02) | Batch #2 (14.02) | Разница |
|---|---|---|---|
| Медиана скорости | ~2.1 МБ/с | ~5.5 МБ/с | **2.6x быстрее** |
| Пиковая скорость | 5.4 МБ/с | 7.6 МБ/с | 1.4x быстрее |

Upload ускорился по двум причинам: (1) отдельная очередь `uploads` устранила конкуренцию с download, (2) сетевые условия для upload были лучше.

### Скорость скачивания по записям (Batch #2)

| ID | Размер | Время DL | Скорость (МБ/с) | Комментарий |
|---|---|---|---|---|
| 589 | 89.5 МБ | 251 сек | 0.36 | Самый быстрый — скачался раньше других |
| 586 | 395.1 МБ | 915 сек | 0.43 | Большой файл — скачивался дольше всех, но и быстрее на МБ |
| 519 | 333.7 МБ | 881 сек | 0.38 | — |
| 591 | 330.3 МБ | 858 сек | 0.39 | — |
| 595 | 314.5 МБ | 874 сек | 0.36 | — |
| 481 | 279.3 МБ | 851 сек | 0.33 | — |
| 527 | 197.4 МБ | 704 сек | 0.28 | — |
| 596 | 159.9 МБ | 633 сек | 0.25 | — |
| 545 | 127.5 МБ | 540 сек | 0.24 | — |
| 546 | 126.2 МБ | 537 сек | 0.24 | Самый медленный на МБ |
| 526 | 128.6 МБ | 462 сек | 0.28 | — |

Закономерность: большие файлы показывают чуть более высокую скорость, т.к. к моменту, когда мелкие файлы уже скачались, оставшиеся получают большую долю канала.

## 26.2 Что реально изменилось (нормализация по сети)

Чтобы корректно сравнить эффект изменения воркеров, нужно исключить влияние скорости интернета. Сравниваем **обработку после скачивания** — этапы, зависящие от системы, а не от сети.

### Время обработки после download (на одну запись)

| Этап | Batch #1 (avg) | Batch #2 (avg) | Изменение |
|---|---|---|---|
| TRIM | 10.4 сек | 8.2 сек | 1.3x быстрее |
| TRANSCRIBE | 40.6 сек | 17.0 сек | **2.4x быстрее** |
| EXTRACT_TOPICS | 20.7 сек | 12.0 сек | **1.7x быстрее** |
| UPLOAD:VK | 144.9 сек | 53.7 сек | **2.7x быстрее** |
| Idle между этапами | 73.4 сек | **~0 сек** | **Устранён** |
| **Итого post-download** | **290 сек** | **91 сек** | **3.2x быстрее** |

> Обработка после скачивания ускорилась **в 3.2 раза**: с 4.8 мин до 1.5 мин на запись.

### Нормализация по длительности контента

Записи в двух батчах были разной длительности (avg 106 мин vs 73 мин). Для честного сравнения — время обработки на минуту контента:

| Этап | Batch #1 (сек/мин) | Batch #2 (сек/мин) | Изменение |
|---|---|---|---|
| TRANSCRIBE | 0.383 | 0.232 | **1.65x быстрее** |
| EXTRACT_TOPICS | 0.195 | 0.164 | 1.19x быстрее |
| TRIM | 0.098 | 0.112 | ~одинаково |

Транскрипция (Fireworks API) стала в 1.65x быстрее на минуту контента — вероятно, за счёт меньшей параллельной нагрузки на API (11 vs 24 запроса). Topics (DeepSeek) тоже чуть быстрее. Trim не изменился, что ожидаемо — это CPU-bound.

## 26.3 Сводная таблица: что ускорилось, а что зависит от сети

| Метрика | Зависит от | Batch #1 | Batch #2 | Вердикт |
|---|---|---|---|---|
| **Download speed** | Интернет | 6.6 МБ/с агрегат | 2.7 МБ/с агрегат | Разный интернет (2.4x) |
| **Idle между этапами** | Архитектура воркеров | 73.4 сек avg | **~0 сек** | **Исправлено** |
| **Upload speed** | Интернет + архитектура | 2.1 МБ/с | 5.5 МБ/с | **Улучшено** (отд. очередь + сеть) |
| **Post-download обработка** | Архитектура воркеров | 290 сек | 91 сек | **3.2x быстрее** |
| **Transcribe per min** | API + нагрузка | 0.383 с/мин | 0.232 с/мин | **1.65x быстрее** |
| **Wall-clock** | Всё вместе | 25.8 мин (24 rec) | 17.1 мин (11 rec) | Несравнимо (разн. кол-во + сеть) |
| **Ошибки** | — | 1 retry | 0 | Стабильно |
| **Записи с idle > 15%** | Архитектура | 8 из 24 (33%) | **0 из 11 (0%)** | **Исправлено** |

## 26.4 Итог

### Что подтверждено

1. **Разделение на 5 очередей полностью устранило простои** — ни одна запись не ждала thread между этапами. Это главная цель изменений, и она достигнута.

2. **Обработка после download ускорилась в 3.2 раза** — с 4 мин 50 сек до 1 мин 31 сек на запись. Это реальное архитектурное улучшение, не зависящее от скорости интернета.

3. **Upload выделен в отдельную очередь и больше не конкурирует с другими задачами.** Скорость upload выросла с медианы 2.1 до 5.5 МБ/с (частично за счёт лучшей сети upload, частично за счёт изоляции очереди).

4. **Система стабильно работает с параллельными запросами от разных пользователей** — запись 462 от другого пользователя обработана без влияния на батч.

### Что нельзя сравнить напрямую

1. **Wall-clock время** — батчи разного размера (24 vs 11 записей) запускались на разном интернете (53 vs 22 Mbps). Прямое сравнение 25.8 мин vs 17.1 мин некорректно.

2. **Throughput (realtime multiplier)** — 98.5x vs 47x. Падение обусловлено меньшим количеством записей и медленным интернетом, а не деградацией системы.

3. **Скорость download из Zoom** — целиком определяется пропускной способностью канала, не архитектурой воркеров.

### Оставшийся bottleneck

**Download из Zoom — единственное узкое место.** Он занимает 88% времени пайплайна (было 67%). Все остальные этапы суммарно укладываются в ~1.5 мин независимо от длительности записи. Дальнейшее ускорение возможно только за счёт:
- более быстрого интернет-канала;
- ограничения параллельных загрузок для повышения скорости на файл;
- кэширования уже скачанных файлов.

### Рекомендации

1. **Для корректного бенчмарка** — провести тест на том же интернете (тот же канал, время суток), чтобы сравнить wall-clock при одинаковой полосе.
2. **Download throttling** — эксперимент с ограничением параллельных загрузок (6–8 вместо 12). При 11 файлах разница небольшая, но при 24+ может дать прирост скорости на файл.
3. **Мониторинг** — Flower/Prometheus для отслеживания queue depth в реальном времени.
4. **Исправить `Event loop is closed` warning** в httpx/DeepSeek клиенте.

---

# Batch Test #3: 7 записей — выгрузка (17.02.2026)

## 27. Исходная выгрузка логов

Фрагмент из `logs/app.log` (строки 252–263), момент старта батча:

```
26-02-17 01:25:11 | INFO | api.routers.recordings:_execute_smart_run:1702 | Smart run: starting full pipeline | rec=603 • status=INITIALIZED
26-02-17 01:25:11 | INFO | api.routers.recordings:_execute_smart_run:1702 | Smart run: starting full pipeline | rec=622 • status=INITIALIZED
26-02-17 01:25:11 | INFO | api.routers.recordings:_execute_smart_run:1702 | Smart run: starting full pipeline | rec=625 • status=INITIALIZED
26-02-17 01:25:11 | INFO | api.routers.recordings:_execute_smart_run:1702 | Smart run: starting full pipeline | rec=631 • status=INITIALIZED
26-02-17 01:25:11 | INFO | api.routers.recordings:_execute_smart_run:1702 | Smart run: starting full pipeline | rec=639 • status=INITIALIZED
26-02-17 01:25:11 | INFO | api.routers.recordings:_execute_smart_run:1702 | Smart run: starting full pipeline | rec=646 • status=INITIALIZED
26-02-17 01:25:11 | INFO | api.routers.recordings:_execute_smart_run:1702 | Smart run: starting full pipeline | rec=650 • status=INITIALIZED
26-02-17 01:25:11 | INFO | api.tasks.processing:run_recording_task:1124 | Task=bc5bba88 • Rec=622 • User=01KGSQMK | Orchestrating pipeline
26-02-17 01:25:11 | INFO | api.tasks.processing:run_recording_task:1124 | Task=2204a636 • Rec=603 • User=01KGSQMK | Orchestrating pipeline
26-02-17 01:25:11 | INFO | api.tasks.processing:run_recording_task:1124 | Task=83b3ec60 • Rec=639 • User=01KGSQMK | Orchestrating pipeline
26-02-17 01:25:11 | INFO | api.tasks.processing:run_recording_task:1124 | Task=d1869026 • Rec=631 • User=01KGSQMK | Orchestrating pipeline
26-02-17 01:25:11 | INFO | api.tasks.processing:run_recording_task:1124 | Task=dd194a97 • Rec=625 • User=01KGSQMK | Orchestrating pipeline
26-02-17 01:25:11 | INFO | api.tasks.processing:run_recording_task:1124 | Task=28d5c44d • Rec=646 • User=01KGSQMK | Orchestrating pipeline
26-02-17 01:25:11 | INFO | api.tasks.processing:run_recording_task:1124 | Task=2a4549e7 • Rec=650 • User=01KGSQMK | Orchestrating pipeline
```

## 28. Анализ выгрузки

### 28.1 Общая сводка

| Метрика | Значение |
|---|---|
| Записей запущено | **7** |
| Успешно обработано | **7 (100%)** |
| Ошибок (failed) | 0 |
| Retry | 1 (rec 622, Fireworks "Bad Gateway" на transcribe, retry успешен) |
| User | 01KGSQMK |
| Wall-clock (от первого start до последнего READY) | **~6 мин** (01:25:11 → 01:31:09) |
| Скачано данных | **~1.96 ГБ** |

### 28.2 Триггер и параллелизм

- Триггер: Smart run для 7 записей в статусе INITIALIZED — одновременный запуск полного пайплайна (вероятно, "Запустить выбранные" или аналогичная операция).
- Все 7 задач `run_recording_task` стартуют в одну секунду (01:25:11).
- Orchestration: все 7 оркестраций начинают "Orchestrating pipeline", resolve config, запускают цепочки (download → trim → transcribe → topics + subs → upload) и завершаются в ту же секунду.
- Сразу после orchestration стартуют 7 download-задач параллельно.

### 28.3 Конфигурация записей

| Rec | Template | Pipeline |
|---|---|---|
| 603 | 33 | download, trim, transcribe, topics, subs, upload |
| 622 | 47 | download, trim, transcribe, topics, subs, upload |
| 625 | 47 | download, trim, transcribe, topics, subs, upload |
| 631 | 56 | download, trim, transcribe, topics, subs, upload |
| 639 | 23 | download, trim, transcribe, topics, subs, upload |
| 646 | 24 | download, trim, transcribe, topics, subs, upload |
| 650 | 40 | download, trim, transcribe, topics, subs, upload |

У всех включён полный пайплайн: download, trim, transcribe, topics, subtitles, upload (VK).

### 28.4 Порядок завершения и характеристики

| Порядок | Rec | Размер DL | Время DL | Transcribe | Topics | Upload | READY |
|---|---|---|---|---|---|---|---|
| 1 | 639 | 157 MB | 83 сек | 19.4 сек | 15.2 сек | 20.1 сек | 01:27:40 |
| 2 | 625 | 246.4 MB | 135 сек | 20.6 сек | 14.3 сек | 52.7 сек | 01:29:03 |
| 3 | 622 | 186.9 MB | 114 сек | **53.4 сек** (retry) | 12.6 сек | 64.5 сек | 01:29:25 |
| 4 | 603 | 261.5 MB | 147 сек | 15.9 сек | 15.8 сек | 80.4 сек | 01:29:41 |
| 5 | 650 | 200.4 MB | 167 сек | 20.9 сек | 13.0 сек | 59.7 сек | 01:29:42 |
| 6 | 646 | 464.6 MB | 212 сек | 38.6 сек | 13.8 сек | 65.5 сек | 01:30:55 |
| 7 | 631 | 447.1 MB | 209 сек | 42.4 сек | 19.9 сек | 65.3 сек | 01:31:09 |

### 28.5 Наблюдения

1. **Retry транскрипции (rec 622):** Fireworks Bad Gateway на первой попытке, retry через 2 сек успешен. Итоговое время transcribe ~53.4 сек vs ~15–20 сек у остальных.
2. **Крупные записи (631, 646):** ~447–465 MB, самая длинная транскрипция (rec 631: 15 594 слов, 42.4 сек). Rec 631 — самая долгая по pipeline (~6 мин).
3. **Параллельное исполнение:** 7 оркестраций и 7 download'ов стартуют одновременно. Очереди downloads/async_operations/processing_cpu/uploads работают штатно.
4. **Скорость download:** ~1.2–2.2 МБ/с на файл при 7 параллельных загрузках (1.96 ГБ за ~3.5 мин).
5. **Fireworks:** 7 параллельных transcribe-запросов, 1 retry (Bad Gateway) — остальные без ошибок.

### 28.6 Выводы

- **7/7 записей успешно** обработаны и загружены в VK.
- **Orchestration** отрабатывает без задержек — все 7 пайплайнов запускаются в одну секунду.
- Retry Fireworks срабатывает корректно при Bad Gateway.
- Архитектура с раздельными очередями (downloads, async_operations, processing_cpu, uploads) выдерживает параллельную обработку 7 записей.
